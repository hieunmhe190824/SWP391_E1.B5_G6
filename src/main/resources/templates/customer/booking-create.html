<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đặt Xe - Car Rental System</title>
    <!-- CSS Variables - Theme Black & Blue -->
    <link rel="stylesheet" th:href="@{/css/variables.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/booking-create.css}">
    <style>
        /* Custom styles for booking confirmation modal */
        #bookingConfirmModal .delete-modal-content {
            max-width: 650px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #bookingConfirmModal .delete-modal-header {
            flex-shrink: 0;
        }

        #bookingConfirmModal .delete-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 2rem;
        }

        #bookingConfirmModal .delete-modal-icon {
            color: var(--color-primary);
        }

        #bookingConfirmModal .delete-modal-footer {
            flex-shrink: 0;
            display: flex !important;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
        }

        #bookingConfirmModal .delete-modal-footer .btn {
            min-width: 120px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 1rem;
            display: inline-block !important;
        }

        #bookingConfirmModal .delete-modal-cancel {
            background: #6b7280 !important;
            color: white !important;
        }

        #bookingConfirmModal .delete-modal-cancel:hover {
            background: #4b5563 !important;
            transform: translateY(-1px);
        }

        #bookingConfirmModal .booking-modal-confirm {
            background: #3b82f6 !important;
            color: white !important;
        }

        #bookingConfirmModal .booking-modal-confirm:hover {
            background: #2563eb !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div th:replace="~{fragments/header :: header}"></div>

    <!-- Load main.js for dropdown functionality -->
    <script th:src="@{/js/main.js}"></script>

    <!-- Main Content -->
    <main class="booking-create-page">
        <div class="page-container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Đặt Xe</h1>
                <p class="page-subtitle">Điền thông tin để hoàn tất đặt xe</p>
            </div>

            <!-- Messages -->
            <div th:if="${errorMessage}" class="alert alert-error" style="margin-bottom: 1.5rem;">
                <span th:text="${errorMessage}">Error message</span>
            </div>

            <!-- Booking Grid -->
            <div class="booking-grid">
                <!-- Left: Vehicle Summary -->
                <div class="vehicle-summary-card">
                    <img th:src="${vehicle.firstImageUrl}"
                         th:alt="${vehicle.model.brand.brandName + ' ' + vehicle.model.modelName}"
                         class="vehicle-image">

                    <h2 class="vehicle-name" th:text="${vehicle.model.brand.brandName + ' ' + vehicle.model.modelName}">
                        Vehicle Name
                    </h2>

                    <div class="vehicle-info-row">
                        <span class="info-label">Biển số</span>
                        <span class="info-value" th:text="${vehicle.licensePlate}">License Plate</span>
                    </div>

                    <div class="vehicle-info-row">
                        <span class="info-label">Năm sản xuất</span>
                        <span class="info-value" th:text="${vehicle.model.year}">Year</span>
                    </div>

                    <div class="vehicle-info-row">
                        <span class="info-label">Loại xe</span>
                        <span class="info-value" th:text="${vehicle.model.category}">Category</span>
                    </div>

                    <div class="vehicle-info-row">
                        <span class="info-label">Giá thuê / ngày</span>
                        <span class="info-value price-highlight" th:text="${#numbers.formatDecimal(vehicle.dailyRate, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                            Daily Rate
                        </span>
                    </div>

                    <div class="vehicle-info-row">
                        <span class="info-label">Tiền cọc</span>
                        <span class="info-value" th:text="${#numbers.formatDecimal(vehicle.depositAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                            Deposit
                        </span>
                    </div>
                </div>

                <!-- Right: Booking Form -->
                <div class="booking-form-card">
                    <form id="bookingForm" th:action="@{/bookings/create}" method="post" th:object="${bookingDTO}">
                        <input type="hidden" name="vehicleId" th:value="${vehicle.id}">

                        <!-- Date Selection -->
                        <div class="form-section">
                            <h3 class="form-section-title">Thời gian thuê</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="startDate" class="required">Ngày bắt đầu</label>
                                    <input type="datetime-local"
                                           id="startDate"
                                           th:field="*{startDate}"
                                           class="form-control"
                                           required
                                           onchange="calculateCost()">
                                </div>

                                <div class="form-group">
                                    <label for="endDate" class="required">Ngày kết thúc</label>
                                    <input type="datetime-local"
                                           id="endDate"
                                           th:field="*{endDate}"
                                           class="form-control"
                                           required
                                           onchange="calculateCost()">
                                </div>
                            </div>
                        </div>

                        <!-- Location Selection -->
                        <div class="form-section">
                            <h3 class="form-section-title">Địa điểm</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pickupLocationId" class="required">Điểm nhận xe</label>
                                    <select id="pickupLocationId"
                                            th:field="*{pickupLocationId}"
                                            class="form-control"
                                            required>
                                        <option value="">-- Chọn điểm nhận --</option>
                                        <option th:each="location : ${locations}"
                                                th:value="${location.id}"
                                                th:text="${location.locationName + ' - ' + location.address}">
                                            Location
                                        </option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="returnLocationId" class="required">Điểm trả xe</label>
                                    <select id="returnLocationId"
                                            th:field="*{returnLocationId}"
                                            class="form-control"
                                            required>
                                        <option value="">-- Chọn điểm trả --</option>
                                        <option th:each="location : ${locations}"
                                                th:value="${location.id}"
                                                th:text="${location.locationName + ' - ' + location.address}">
                                            Location
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Document Selection -->
                        <div class="form-section">
                            <h3 class="form-section-title">Giấy tờ đính kèm</h3>

                            <div class="document-list" th:if="${userDocuments != null and !userDocuments.isEmpty()}">
                                <label class="document-item" th:each="doc : ${userDocuments}">
                                    <input type="checkbox"
                                           name="documentIds"
                                           th:value="${doc.id}">
                                    <div class="document-info">
                                        <div class="document-type" th:text="${doc.documentType.name() == 'ID_Card' ? 'CMND/CCCD' : 'Bằng lái xe'}">
                                            Document Type
                                        </div>
                                        <div class="document-number" th:text="'Số: ' + ${doc.documentNumber}">
                                            Document Number
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div th:if="${userDocuments == null or userDocuments.isEmpty()}"
                                 class="alert alert-warning">
                                <p>Bạn chưa có giấy tờ nào. Vui lòng <a th:href="@{/profile/documents/add}">thêm giấy tờ</a> trước khi đặt xe.</p>
                            </div>
                        </div>

                        <!-- Cost Summary -->
                        <div class="cost-summary">
                            <div class="cost-row">
                                <span>Số ngày thuê</span>
                                <span id="totalDays">0 ngày</span>
                            </div>
                            <div class="cost-row">
                                <span>Giá thuê</span>
                                <span id="rentalFee">0 VND</span>
                            </div>
                            <div class="cost-row">
                                <span>Tiền cọc</span>
                                <span th:text="${#numbers.formatDecimal(vehicle.depositAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                                    Deposit
                                </span>
                            </div>
                            <div class="cost-row cost-total">
                                <span>Tổng cộng</span>
                                <span id="totalAmount">0 VND</span>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="button" id="showConfirmModal" class="btn-submit">Xác nhận đặt xe</button>
                            <a th:href="@{/vehicles/{id}(id=${vehicle.id})}" class="btn-cancel">Hủy</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Booking Confirmation Modal -->
    <div th:replace="~{fragments/components/modals :: bookingConfirmModal}"></div>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const dailyRate = /*[[${vehicle.dailyRate}]]*/ 0;
        const depositAmount = /*[[${vehicle.depositAmount}]]*/ 0;

        function calculateCost() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const endDateGroup = document.getElementById('endDate').closest('.form-group');

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                // Validate: End date must be after start date
                if (end <= start) {
                    // Add error class to show red asterisk
                    endDateGroup.classList.add('error');
                    document.getElementById('totalDays').textContent = '0 ngày';
                    document.getElementById('rentalFee').textContent = '0 VND';
                    document.getElementById('totalAmount').textContent = formatNumber(depositAmount) + ' VND';
                    return;
                } else {
                    // Remove error class
                    endDateGroup.classList.remove('error');
                }

                // Calculate days
                const diffTime = end - start;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const totalDays = diffDays < 1 ? 1 : diffDays;

                // Calculate costs
                const rentalFee = dailyRate * totalDays;
                const totalAmount = rentalFee + depositAmount;

                // Update display
                document.getElementById('totalDays').textContent = totalDays + ' ngày';
                document.getElementById('rentalFee').textContent = formatNumber(rentalFee) + ' VND';
                document.getElementById('totalAmount').textContent = formatNumber(totalAmount) + ' VND';
            }
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Set minimum date to current day in Vietnam timezone (UTC+7) so users can pick any time today
        const toVnDate = () => {
            const now = new Date();
            const vnString = now.toLocaleString('en-US', { timeZone: 'Asia/Ho_Chi_Minh' });
            return new Date(vnString);
        };
        const pad = (num) => String(num).padStart(2, '0');
        const vnNow = toVnDate();
        const startOfTodayVn = `${vnNow.getFullYear()}-${pad(vnNow.getMonth() + 1)}-${pad(vnNow.getDate())}T00:00`;
        document.getElementById('startDate').min = startOfTodayVn;
        document.getElementById('endDate').min = startOfTodayVn;

        // Update end date minimum when start date changes
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('endDate').min = this.value;
            calculateCost();
        });

        // Validate when end date changes
        document.getElementById('endDate').addEventListener('change', function() {
            calculateCost();
        });

        // Form submission validation
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (end <= start) {
                    e.preventDefault();
                    alert('Ngày kết thúc phải sau ngày bắt đầu!');
                    document.getElementById('endDate').focus();
                    return false;
                }
            }
        });

        // ===== BOOKING CONFIRMATION MODAL LOGIC =====
        const vehicleName = /*[[${vehicle.model.brand.brandName + ' ' + vehicle.model.modelName}]]*/ '';
        const vehicleLicensePlate = /*[[${vehicle.licensePlate}]]*/ '';

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show confirmation modal when clicking submit button
            const showModalBtn = document.getElementById('showConfirmModal');
            if (!showModalBtn) {
                console.error('Button showConfirmModal not found!');
                return;
            }

            showModalBtn.addEventListener('click', function(e) {
                e.preventDefault();

                // Validate form first
                const form = document.getElementById('bookingForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Validate dates
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (!startDate || !endDate) {
                    alert('Vui lòng chọn ngày bắt đầu và ngày kết thúc!');
                    return;
                }

                const start = new Date(startDate);
                const end = new Date(endDate);

                if (end <= start) {
                    alert('Ngày kết thúc phải sau ngày bắt đầu!');
                    return;
                }

                // Get selected locations
                const pickupLocationSelect = document.getElementById('pickupLocationId');
                const returnLocationSelect = document.getElementById('returnLocationId');
                const pickupLocation = pickupLocationSelect.options[pickupLocationSelect.selectedIndex].text;
                const returnLocation = returnLocationSelect.options[returnLocationSelect.selectedIndex].text;

                // Calculate costs
                const diffTime = end - start;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const totalDays = diffDays < 1 ? 1 : diffDays;
                const rentalFee = dailyRate * totalDays;
                const totalAmount = rentalFee + depositAmount;

                // Format dates for display
                const formatDateTime = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleString('vi-VN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                // Populate modal with booking details
                const detailsHtml = `
                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Xe:</strong>
                            <span>${vehicleName} (${vehicleLicensePlate})</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Ngày bắt đầu:</strong>
                            <span>${formatDateTime(startDate)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Ngày kết thúc:</strong>
                            <span>${formatDateTime(endDate)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Số ngày thuê:</strong>
                            <span>${totalDays} ngày</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Địa điểm nhận xe:</strong>
                            <span>${pickupLocation}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Địa điểm trả xe:</strong>
                            <span>${returnLocation}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Phí thuê xe:</strong>
                            <span>${formatNumber(rentalFee)} VND</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--color-border);">
                            <strong>Tiền cọc:</strong>
                            <span>${formatNumber(depositAmount)} VND</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; font-size: 1.1rem; font-weight: 700; color: var(--color-primary);">
                            <strong>Tổng cộng:</strong>
                            <span>${formatNumber(totalAmount)} VND</span>
                        </div>
                    </div>
                `;

                document.getElementById('bookingConfirmDetails').innerHTML = detailsHtml;

                // Show modal by adding 'active' class
                const modal = document.getElementById('bookingConfirmModal');
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                    console.log('Modal should be visible now');
                } else {
                    console.error('Modal element not found!');
                }
            });

            // Handle modal cancel button
            const cancelBtn = document.querySelector('#bookingConfirmModal .delete-modal-cancel');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    const modal = document.getElementById('bookingConfirmModal');
                    modal.classList.remove('active');
                    document.body.style.overflow = ''; // Restore scrolling
                });
            }

            // Handle modal overlay click
            const overlay = document.querySelector('#bookingConfirmModal .delete-modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', function() {
                    const modal = document.getElementById('bookingConfirmModal');
                    modal.classList.remove('active');
                    document.body.style.overflow = ''; // Restore scrolling
                });
            }

            // Handle modal confirm button - submit the form
            const confirmBtn = document.querySelector('#bookingConfirmModal .booking-modal-confirm');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    const modal = document.getElementById('bookingConfirmModal');
                    modal.classList.remove('active');
                    document.body.style.overflow = ''; // Restore scrolling
                    document.getElementById('bookingForm').submit();
                });
            }
        }); // End of DOMContentLoaded
        /*]]>*/
    </script>
</body>
</html>
